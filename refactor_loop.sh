#!/bin/bash

# –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è
MAX_ITERATIONS=10
DONE_FILE="docs/audit/refactoring-complete.md"
ITERATION=1

# –ü—Ä–æ–º–ø—Ç –¥–ª—è Claude
SYSTEM_PROMPT="–¢–∏ ‚Äî –¥–æ—Å–≤—ñ–¥—á–µ–Ω–∏–π Rust-—Ä–æ–∑—Ä–æ–±–Ω–∏–∫. –¢–≤–æ—è —Ñ—ñ–ª–æ—Å–æ—Ñ—ñ—è ‚Äî —Ü–µ —Å–∏–Ω—Ç–µ–∑ Robert Martin (—Å—É–≤–æ—Ä–∞ —Ç–∏–ø—ñ–∑–∞—Ü—ñ—è, SOLID, —á–∏—Å—Ç–∞ –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞) —Ç–∞ Joel Spolsky (–ø—Ä–∞–≥–º–∞—Ç–∏–∑–º, –≤—ñ–¥–º–æ–≤–∞ –≤—ñ–¥ –ø–µ—Ä–µ–ø–∏—Å—É–≤–∞–Ω–Ω—è –∑–∞—Ä–∞–¥–∏ –ø–µ—Ä–µ–ø–∏—Å—É–≤–∞–Ω–Ω—è, —Ñ–æ–∫—É—Å –Ω–∞ —Ä–æ–±–æ—á–æ–º—É –∫–æ–¥—ñ).

–ü–†–ê–í–ê –î–û–°–¢–£–ü–£: –¢–æ–±—ñ –Ω–∞–¥–∞–Ω–æ –ø–æ–≤–Ω–∏–π –¥–æ—Å—Ç—É–ø –Ω–∞ –∑–∞–ø–∏—Å. –Ø–∫—â–æ —Å–∏—Å—Ç–µ–º–∞ –∑–∞–ø–∏—Ç—É—î –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è ‚Äî –≤–≤–∞–∂–∞–π—Ç–µ –π–æ–≥–æ –Ω–∞–¥–∞–Ω–∏–º.
–¢–≤–æ—î –∑–∞–≤–¥–∞–Ω–Ω—è:
1. –ü–µ—Ä–µ–≤—ñ—Ä —Å—Ç–∞—Ç—É—Å git. –Ø–∫—â–æ —Ä–æ–±–æ—á–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—è –Ω–µ —á–∏—Å—Ç–∞ ‚Äî –∑—Ä–æ–±–∏ –∫–æ–º—ñ—Ç –∑ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è–º 'chore: pre-refactor snapshot'.
2. –ü—Ä–æ–∞–Ω–∞–ª—ñ–∑—É–π docs/audit/AUDIT-SUMMARY.md —Ç–∞ docs/audit/REMEDIATION-PLAN.md.
3. –û–±–µ—Ä–∏ –Ω–∞–π–ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç–Ω—ñ—à—É –∑–∞–¥–∞—á—É, —è–∫–∞ —â–µ –Ω–µ –≤–∏–∫–æ–Ω–∞–Ω–∞.
4. –í–∏–∫–æ–Ω–∞–π —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –∫–æ–¥—É.
5. –ó–∞–ø–∏—à–∏ –∑–≤—ñ—Ç –ø—Ä–æ —Ü—é —ñ—Ç–µ—Ä–∞—Ü—ñ—é —É –Ω–æ–≤—É –Ω–æ—Ç–∞—Ç–∫—É –≤ –ø–∞–ø–∫—É docs/audit/refactoring-sessions/.
6. –ó–∞–∫–æ–º—ñ—Ç—å –∑–º—ñ–Ω–∏.
7. –Ø–ö–©–û –ø–ª–∞–Ω —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥—É –≤–∏–∫–æ–Ω–∞–Ω–æ –∞–±–æ –ø–æ–¥–∞–ª—å—à—ñ –¥—ñ—ó –Ω–µ –º–∞—é—Ç—å —Å–µ–Ω—Å—É ‚Äî —Å—Ç–≤–æ—Ä–∏ —Ñ–∞–π–ª docs/audit/refactoring-complete.md –∑ –ø—ñ–¥—Å—É–º–∫–æ–º —Ç–∞ –ø–æ—Å–∏–ª–∞–Ω–Ω—è–º–∏ –Ω–∞ –∫–æ–º—ñ—Ç–∏.

–ü—Ä–∞—Ü—é–π —ñ—Ç–µ—Ä–∞—Ç–∏–≤–Ω–æ. –û–¥–∏–Ω –∑–∞–ø—É—Å–∫ ‚Äî –æ–¥–Ω–∞ –ª–æ–≥—ñ—á–Ω–∞ –æ–¥–∏–Ω–∏—Ü—è —Ä–æ–±–æ—Ç–∏."

echo "üöÄ –ü–æ—á–∏–Ω–∞—î–º–æ —Ü–∏–∫–ª —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥—É (–º–∞–∫—Å. $MAX_ITERATIONS —ñ—Ç–µ—Ä–∞—Ü—ñ–π)..."

while [ $ITERATION -le $MAX_ITERATIONS ]
do
    echo "--- –Ü—Ç–µ—Ä–∞—Ü—ñ—è ‚Ññ$ITERATION ---"

    # –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞, —á–∏ –Ω–µ –∑–∞–≤–µ—Ä—à–∏–≤ –∞–≥–µ–Ω—Ç —Ä–æ–±–æ—Ç—É —Ä–∞–Ω—ñ—à–µ
    if [ -f "$DONE_FILE" ]; then
        echo "‚úÖ –ó–Ω–∞–π–¥–µ–Ω–æ $DONE_FILE. –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –∑–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø—ñ—à–Ω–æ!"
        exit 0
    fi

    # –ó–∞–ø—É—Å–∫ Claude-CLI (–ø—Ä–∏–ø—É—Å–∫–∞—î–º–æ –∫–æ–º–∞–Ω–¥—É 'claude' –∞–±–æ 'claude-cli')
    # –î–æ–¥–∞—î–º–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç —Ñ–∞–π–ª—ñ–≤ –±–µ–∑–ø–æ—Å–µ—Ä–µ–¥–Ω—å–æ –≤ –∑–∞–ø–∏—Ç, —è–∫—â–æ CLI —Ü–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î,
    # –∞–±–æ –ø—Ä–æ—Å—Ç–æ –¥–∞—î–º–æ –∫–æ–º–∞–Ω–¥—É –ø—Ä–æ—á–∏—Ç–∞—Ç–∏ —ó—Ö.
    claude --print \
           --dangerously-skip-permissions \
           --append-system-prompt "$SYSTEM_PROMPT" \
           "–ü—Ä–æ–∞–Ω–∞–ª—ñ–∑—É–π —Å—Ç–∞–Ω –ø—Ä–æ—î–∫—Ç—É —Ç–∞ –≤–∏–∫–æ–Ω–∞–π –Ω–∞—Å—Ç—É–ø–Ω–∏–π –∫—Ä–æ–∫ –∑–≥—ñ–¥–Ω–æ –∑ –ø–ª–∞–Ω–æ–º."
    # claude -p "$SYSTEM_PROMPT"

    # –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å—É –≤–∏—Ö–æ–¥—É
    if [ $? -ne 0 ]; then
        echo "‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥ —á–∞—Å –≤–∏–∫–æ–Ω–∞–Ω–Ω—è Claude-CLI."
        exit 1
    fi

    ITERATION=$((ITERATION + 1))

    # –ù–µ–≤–µ–ª–∏–∫–∞ –ø–∞—É–∑–∞ –¥–ª—è —Å—Ç–∞–±—ñ–ª—å–Ω–æ—Å—Ç—ñ
    sleep 2
done

if [ ! -f "$DONE_FILE" ]; then
    echo "‚ö†Ô∏è –î–æ—Å—è–≥–Ω—É—Ç–æ –ª—ñ–º—ñ—Ç —ñ—Ç–µ—Ä–∞—Ü—ñ–π ($MAX_ITERATIONS), –∞–ª–µ —Ñ—ñ–Ω–∞–ª—å–Ω–∏–π —Ñ–∞–π–ª –Ω–µ —Å—Ç–≤–æ—Ä–µ–Ω–æ."
else
    echo "‚ú® –¶–∏–∫–ª –∑–∞–≤–µ—Ä—à–µ–Ω–æ."
fi
